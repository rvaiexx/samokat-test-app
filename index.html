<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Самокат — Доставка за 15 минут</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f7; }
        .cart-open { transform: translateX(0) !important; }
        .active-cat { background: white; color: #FF335F; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .rounded-samokat { border-radius: 32px; }
        .tg-gradient {
            background: linear-gradient(135deg, #0088cc 0%, #00acee 100%);
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
        }
        .tg-gradient:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="antialiased text-[#1a1a1a]">

    <div id="auth-modal" class="fixed inset-0 bg-black/50 z-[300] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-samokat p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">Вход</h2>
                <button onclick="closeModals()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <input type="tel" placeholder="+7 (___) ___-__-__" class="w-full bg-gray-100 border-none rounded-2xl py-4 px-6 mb-4 text-lg outline-none focus:ring-2 focus:ring-[#FF335F]">
            <button onclick="closeModals()" class="w-full bg-[#FF335F] text-white py-4 rounded-2xl font-bold text-lg">Получить код</button>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black/50 z-[300] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-samokat p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic">Оформление</h2>
                <button onclick="closeModals()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="order-address" placeholder="Улица и дом" class="w-full bg-gray-100 border-none rounded-2xl py-4 px-6 outline-none focus:ring-2 focus:ring-[#FF335F]">
                <div class="grid grid-cols-3 gap-3">
                    <input type="text" placeholder="Подъезд" class="bg-gray-100 border-none rounded-2xl py-4 px-4 outline-none">
                    <input type="text" placeholder="Этаж" class="bg-gray-100 border-none rounded-2xl py-4 px-4 outline-none">
                    <input type="text" placeholder="Кв." class="bg-gray-100 border-none rounded-2xl py-4 px-4 outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Ваш ID в Telegram (для отслеживания)</label>
                    <input type="text" id="order-telegram-id" placeholder="Напишите боту /id чтобы узнать" 
                           class="w-full bg-gray-100 border-none rounded-2xl py-4 px-6 mt-1 outline-none focus:ring-2 focus:ring-[#FF335F]">
                </div>
                <div class="p-4 bg-pink-50 rounded-2xl">
                    <div class="flex justify-between font-black text-xl text-[#FF335F]">
                        <span>К оплате:</span>
                        <span id="final-price-display">0 ₽</span>
                    </div>
                </div>
                <button onclick="confirmOrder()" class="w-full bg-[#FF335F] text-white py-5 rounded-2xl font-bold text-lg">Заказать</button>
            </div>
        </div>
    </div>

    <div id="cart-sidebar" class="fixed right-0 top-0 h-full w-full md:w-[420px] bg-white z-[250] shadow-2xl translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-6 flex justify-between items-center border-b">
            <h2 class="text-2xl font-black">Корзина</h2>
            <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
        </div>
        <div id="cart-list" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar"></div>
        <div class="p-6 border-t space-y-4">
            <div class="flex justify-between items-center font-bold text-lg italic">
                <span>Итого</span>
                <span id="cart-total-price">0 ₽</span>
            </div>
            <button onclick="openCheckout()" class="w-full bg-[#FF335F] text-white py-5 rounded-2xl font-bold text-lg">Оформить заказ</button>
        </div>
    </div>

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-[100] border-b border-gray-100 h-20">
        <div class="max-w-[1400px] mx-auto px-6 h-full flex items-center justify-between">
            <div class="bg-[#FF335F] text-white font-black px-5 py-2 rounded-2xl text-2xl tracking-tighter cursor-pointer italic">САМОКАТ</div>
            <div class="flex items-center gap-4">
                <a href="https://t.me/privatzzbot" target="_blank" class="tg-gradient text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 transition-all">
                    <svg fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.55 8.926l-2.074 9.172c-.172.766-.637.954-1.284.62L12.02 15.5l-2.075 1.996c-.187.18-.344.333-.656.333-.312 0-.484-.15-.67-.323l-3.375-3.256c-.46-.44-.14-.688.3-.547l10.9-4.148c.453-.172.859-.047.67.28z"/>
                    </svg>
                    Наш бот
                </a>
                <button onclick="openAuth()" class="p-3 hover:bg-gray-100 rounded-2xl transition"><i data-lucide="user"></i></button>
                <button onclick="toggleCart()" class="bg-[#FF335F] text-white px-6 py-2.5 rounded-2xl font-bold flex items-center gap-2">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="header-cart-total">0 ₽</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-[1400px] mx-auto px-6 flex gap-10 mt-10">
        <aside class="hidden md:block w-64 shrink-0">
            <nav id="cat-nav" class="sticky top-28 space-y-1"></nav>
        </aside>
        <main class="flex-1 pb-20">
            <h1 id="cat-title" class="text-4xl font-black mb-10 italic">Все продукты</h1>
            <div id="catalog-grid" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // КОНФИГУРАЦИЯ FIREBASE (ВСТАВЬ СВОЮ ССЫЛКУ ТУТ)
        const firebaseConfig = {
            databaseURL: "https://samokat-test-default-rtdb.europe-west1.firebasedatabase.app/"
        };
        

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let products = [];
        let cart = {}; 
        let currentCat = "Все";
        const categories = ["Все", "Выпечка", "Молоко", "Фрукты"];

        // Получение данных из Firebase
        onValue(ref(db, 'products'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                products = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                renderProducts();
                updateUI();
            }
        });

        window.updateQty = (id, delta) => {
            const p = products.find(x => x.id == id);
            const inCart = cart[id] || 0;

            if (delta > 0 && p.stock > 0) {
                cart[id] = inCart + 1;
                update(ref(db, `products/${id}`), { stock: p.stock - 1 });
            } else if (delta < 0 && inCart > 0) {
                cart[id] = inCart - 1;
                update(ref(db, `products/${id}`), { stock: p.stock + 1 });
                if (cart[id] === 0) delete cart[id];
            }
        };

        window.confirmOrder = () => {
            const address = document.getElementById('order-address').value;
            const tgId = document.getElementById('order-telegram-id').value;
            
            if (!address || !tgId) return alert('Заполните адрес и ваш Telegram ID!');
            
            const orderData = {
                address: address,
                telegram_id: tgId,
                items: cart,
                status: "Принят", 
                total: document.getElementById('cart-total-price').innerText,
                timestamp: Date.now()
            };
            
            push(ref(db, 'orders'), orderData).then(() => {
                // После успешного заказа открываем бота
                window.open(`https://t.me/privatzzbot`, '_blank');
                alert('Заказ принят! Отслеживайте статус в боте.');
                cart = {};
                closeModals();
                updateUI();
            });
        };

        // Функции рендеринга (оставляем старую логику отображения)
        function renderProducts() {
            const grid = document.getElementById('catalog-grid');
            const filtered = products.filter(p => currentCat === "Все" || p.cat === currentCat);
            grid.innerHTML = filtered.map(p => {
                const count = cart[p.id] || 0;
                const outOfStock = p.stock <= 0;
                return `
                    <div class="bg-white p-4 rounded-samokat shadow-sm transition hover:shadow-xl ${outOfStock ? 'opacity-50' : ''}">
                        <img src="${p.img}" class="w-full h-40 object-cover rounded-2xl mb-4">
                        <div class="text-2xl font-black mb-1">${p.price} ₽</div>
                        <div class="text-sm font-semibold h-10 line-clamp-2 mb-2">${p.name}</div>
                        <div class="text-[10px] font-black uppercase mb-4 ${p.stock < 3 && p.stock > 0 ? 'text-red-500' : 'text-gray-400'}">
                            ${outOfStock ? 'Закончился' : `Осталось: ${p.stock} шт`}
                        </div>
                        ${!outOfStock ? (count > 0 ? `
                            <div class="flex items-center justify-between bg-gray-100 rounded-2xl p-1">
                                <button onclick="updateQty('${p.id}', -1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-bold text-[#FF335F]">-</button>
                                <span class="font-bold">${count}</span>
                                <button onclick="updateQty('${p.id}', 1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-bold text-[#FF335F]">+</button>
                            </div>
                        ` : `
                            <button onclick="updateQty('${p.id}', 1)" class="w-full bg-gray-100 hover:bg-[#FF335F] hover:text-white py-3.5 rounded-2xl font-bold transition">Добавить</button>
                        `) : `<div class="py-3.5 text-center text-gray-400 font-bold italic">Нет в наличии</div>`}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function updateUI() {
            let total = 0;
            const cartList = document.getElementById('cart-list');
            let html = '';
            for (let id in cart) {
                const p = products.find(x => x.id == id);
                if (!p) continue;
                total += p.price * cart[id];
                html += `<div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
                    <img src="${p.img}" class="w-16 h-16 rounded-xl object-cover">
                    <div class="flex-1 font-bold text-sm"><div>${p.name}</div><div class="text-[#FF335F]">${p.price * cart[id]} ₽</div></div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQty('${id}', -1)" class="w-8 h-8 bg-white rounded-lg border text-[#FF335F]">-</button>
                        <span class="font-bold">${cart[id]}</span>
                        <button onclick="updateQty('${id}', 1)" class="w-8 h-8 bg-white rounded-lg border text-[#FF335F]">+</button>
                    </div>
                </div>`;
            }
            cartList.innerHTML = html || '<div class="text-center py-20 text-gray-400 font-bold italic">Корзина пуста</div>';
            document.getElementById('header-cart-total').innerText = total + ' ₽';
            document.getElementById('cart-total-price').innerText = total + ' ₽';
            document.getElementById('final-price-display').innerText = total + ' ₽';
        }

        window.setCat = (c) => { currentCat = c; renderCats(); renderProducts(); };
        function renderCats() {
            document.getElementById('cat-nav').innerHTML = categories.map(c => `
                <button onclick="setCat('${c}')" class="w-full flex items-center p-4 rounded-2xl font-bold transition ${currentCat === c ? 'active-cat' : 'hover:bg-white/40'}">${c}</button>
            `).join('');
        }

        // Вспомогательные функции (в глобальную область для onclick)
        window.toggleCart = () => document.getElementById('cart-sidebar').classList.toggle('cart-open');
        window.openAuth = () => document.getElementById('auth-modal').classList.toggle('hidden');
        window.openCheckout = () => { if(Object.keys(cart).length) document.getElementById('checkout-modal').classList.remove('hidden'); };
        window.closeModals = () => { document.getElementById('auth-modal').classList.add('hidden'); document.getElementById('checkout-modal').classList.add('hidden'); };

        renderCats();
        lucide.createIcons();
    </script>
</body>
</html>